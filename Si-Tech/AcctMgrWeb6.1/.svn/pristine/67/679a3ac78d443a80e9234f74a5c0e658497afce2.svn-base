package com.sitech.acctmgr.atom.impl.pay;

import static org.apache.commons.collections.MapUtils.safeAddToMap;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.sitech.acctmgr.atom.busi.pay.inter.IPayManage;
import com.sitech.acctmgr.atom.busi.pay.inter.IPayOpener;
import com.sitech.acctmgr.atom.busi.pay.inter.ITransType;
import com.sitech.acctmgr.atom.busi.pay.inter.IWriteOffer;
import com.sitech.acctmgr.atom.busi.pay.trans.TransFactory;
import com.sitech.acctmgr.atom.domains.account.ContractDeadInfoEntity;
import com.sitech.acctmgr.atom.domains.account.ContractInfoEntity;
import com.sitech.acctmgr.atom.domains.account.CsAccountRelEntity;
import com.sitech.acctmgr.atom.domains.base.ChngroupRelEntity;
import com.sitech.acctmgr.atom.domains.cust.CustInfoEntity;
import com.sitech.acctmgr.atom.domains.pay.GroupChargeEntity;
import com.sitech.acctmgr.atom.domains.pay.GroupRelConInfo;
import com.sitech.acctmgr.atom.domains.pay.PayBookEntity;
import com.sitech.acctmgr.atom.domains.pay.PayUserBaseEntity;
import com.sitech.acctmgr.atom.domains.record.LoginOprEntity;
import com.sitech.acctmgr.atom.domains.user.UserDeadEntity;
import com.sitech.acctmgr.atom.domains.user.UserInfoEntity;
import com.sitech.acctmgr.atom.dto.pay.S8078CfmInDTO;
import com.sitech.acctmgr.atom.dto.pay.S8078CfmOutDTO;
import com.sitech.acctmgr.atom.dto.pay.S8078InitInDTO;
import com.sitech.acctmgr.atom.dto.pay.S8078InitOutDTO;
import com.sitech.acctmgr.atom.dto.pay.S8203CfmInDTO;
import com.sitech.acctmgr.atom.dto.pay.S8203CfmOutDTO;
import com.sitech.acctmgr.atom.dto.pay.S8203InitInDTO;
import com.sitech.acctmgr.atom.dto.pay.S8203InitOutDTO;
import com.sitech.acctmgr.atom.entity.inter.IAccount;
import com.sitech.acctmgr.atom.entity.inter.IBalance;
import com.sitech.acctmgr.atom.entity.inter.IControl;
import com.sitech.acctmgr.atom.entity.inter.ICust;
import com.sitech.acctmgr.atom.entity.inter.IGroup;
import com.sitech.acctmgr.atom.entity.inter.IRecord;
import com.sitech.acctmgr.atom.entity.inter.IUser;
import com.sitech.acctmgr.common.AcctMgrBaseService;
import com.sitech.acctmgr.common.AcctMgrError;
import com.sitech.acctmgr.inter.pay.I8078;
import com.sitech.jcf.core.exception.BusiException;
import com.sitech.jcfx.anno.ParamType;
import com.sitech.jcfx.anno.ParamTypes;
import com.sitech.jcfx.dt.in.InDTO;
import com.sitech.jcfx.dt.out.OutDTO;

@ParamTypes({ @ParamType(m = "init", c = S8078InitInDTO.class, oc = S8078InitOutDTO.class),
	  @ParamType(m = "cfm", c = S8078CfmInDTO.class,oc = S8078CfmOutDTO.class)})
public class S8078 extends AcctMgrBaseService implements I8078{
	
	private IUser user;
	private ICust cust;
	private IGroup group;
	private IRecord record;
	private IPayManage payManage;
	private IWriteOffer	writeOffer;
	private IPayOpener payOpener;
	private IControl control;
	private IBalance balance;
	private IAccount account;
	protected TransFactory transFactory;
	
	@Override
	public OutDTO init(InDTO inParam) {
		
		//每月五号以后才能划拨
		Calendar c = Calendar.getInstance();
		int datenum=c.get(Calendar.DATE);
		if(datenum < 6){
			throw new BusiException(AcctMgrError.getErrorCode("8078", "00002"), "本月五号以后才能划拨！");
		}
		
		// 获取入参信息
		S8078InitInDTO inDto = (S8078InitInDTO)inParam;
		long contractNo = inDto.getContractNo();
		
		//获取统付账户信息
		Map<String,Object> groupInfo = new HashMap<String,Object>();
		Map<String,Object> acctBookMap = new HashMap<String,Object>();
		UserInfoEntity baseinfo = (UserInfoEntity)user.getUserEntityByConNo(contractNo, true);
		ContractInfoEntity cie = account.getConInfo(contractNo);
		String accountType = cie.getContractattType();
		long custId = cie.getCustId();
		long idNo = baseinfo.getIdNo();
		String phoneNo = baseinfo.getPhoneNo();
		long curBalance = 0;
		
		groupInfo = (Map<String, Object>) user.getUrGrpInfo(idNo);
		String groupName = (String)groupInfo.get("GROUP_NAME");
		
		//已销户用户不能做划拨
		//判断是否是合约计划-集团版用户，如果是，不做划拨
		//获取账户预存
		acctBookMap.put("CONTRACT_NO", contractNo);
		acctBookMap.put("PAY_TYPE", "0"); //支付账户预存只从现金账本划拨
		List<Map<String,Object>> acctBook = balance.getAcctBookList(acctBookMap);
		for (Map<String, Object> specMap : acctBook) {
			curBalance += Long.parseLong(specMap.get("CUR_BALANCE").toString());
		}
		log.info("类型————————————>"+ accountType);
		if(!(accountType.equals("1") || accountType.equals("A"))){
			throw new BusiException(AcctMgrError.getErrorCode("8078", "00001"), "不是统付账号或一点支付账号");
		}
		
		//获取省内一点支付和集团统付账户二级账户列表
		List<CsAccountRelEntity> listRelCon = account.getAccountRelList(contractNo,"9", "2");
		int relConSize = listRelCon.size();//二级账户数目
		List<GroupRelConInfo> relConList = new ArrayList<GroupRelConInfo>();
		for(CsAccountRelEntity accountEnt : listRelCon){
			GroupRelConInfo relConInfo = new GroupRelConInfo();
			long relCon = accountEnt.getRelContractNo();
			long payValue = accountEnt.getPayValue();
			
			//剔除已支付账户
			boolean isPayOrNot = balance.deleteHavePayCon(contractNo, relCon);
			log.info("中断标志:"+isPayOrNot);
			if(isPayOrNot){
				log.info("进入中断");
				continue;
			}
			
			//获取二级账户用户信息
			UserInfoEntity relUserInfo = user.getUserEntityByConNo(relCon, true);
			String relPhoneNo = relUserInfo.getPhoneNo();
			long relCustId = relUserInfo.getCustId();
			
			//获取客户姓名
			CustInfoEntity custEnt = cust.getCustInfo(relCustId, null);
			String conEncrypName = custEnt.getBlurCustName();
			
			relConInfo.setRelCon(relCon);
			relConInfo.setPayValue(payValue);
			relConInfo.setRelPhoneNo(relPhoneNo);
			relConInfo.setConEncrypName(conEncrypName);
			log.info("出来啊------>" + relConInfo.toString());
			relConList.add(relConInfo);
			
		}
		
		S8078InitOutDTO outDto = new S8078InitOutDTO();
		outDto.setAccountType(accountType);
		outDto.setCurBalance(curBalance);
		outDto.setCustId(custId);
		outDto.setPhoneNo(phoneNo);
		outDto.setGroupName(groupName);
		outDto.setRelConList(relConList);
		
		return outDto;
	}

	@Override
	public OutDTO cfm(InDTO inParam) {
		
		Map<String,Object> inTransCfmMap = null;
		String totalDate = ""; // 转账日期
		String curYM = "";
		
		// TODO Auto-generated method stub
		S8078CfmInDTO inDto = (S8078CfmInDTO)inParam;
		String provinceId = inDto.getProvinceId();
		String opType = inDto.getOpType();
		log.info("掉链子的optype:"+opType);
		String groupId = inDto.getGroupId();
		String loginNo = inDto.getLoginNo();
		String opCode = inDto.getOpCode();
		String opNote = inDto.getOpNote();
		String payPath = inDto.getPayPath();
		String payMethod = inDto.getPayMethod();
		long shouldPay = inDto.getShouldPay();
		long outContractNo = inDto.getOutContractNo();
		long outPhoneNo = inDto.getOutPhoneNo();
		String outPhoneNoStr = String.valueOf(outPhoneNo);
		List<GroupRelConInfo> relConList = inDto.getRelConList();
		long foreignSn = control.getSequence("SEQ_PAY_SN");
		String foreignSnStr = String.valueOf(foreignSn);
		
		/* 获取当前日期 */
		String curTime = control.getSysDate().get("CUR_TIME").toString();
		totalDate = curTime.substring(0, 8);
		curYM = curTime.substring(0, 6);
		
		/*入账实体设值*/
		PayBookEntity bookIn = new PayBookEntity();
		bookIn.setBeginTime(curTime);
		bookIn.setForeignSn(foreignSnStr);
		bookIn.setGroupId(groupId);
		bookIn.setLoginNo(loginNo);
		bookIn.setOpCode(opCode);
		bookIn.setOpNote(opNote);
		bookIn.setPayMethod(payMethod);
		bookIn.setPayPath(payPath);
		bookIn.setTotalDate(Integer.parseInt(totalDate));
		bookIn.setYearMonth(Long.parseLong(curYM));
		
		//转账类型
		ITransType transType = transFactory.createTransFactory("TransAccountGrp",true);
		
		//获取转出账户信息
		PayUserBaseEntity outTransBaseInfo= getUserBaseInfo(outPhoneNoStr, outContractNo, true, provinceId);
		for(GroupRelConInfo gce:relConList){
			String phoneNo=gce.getRelPhoneNo();
			long payMoney=gce.getPayValue();
			long contractNo=gce.getRelCon();
			bookIn.setPayFee(payMoney);
			//获取转入账户信息
			PayUserBaseEntity inTransBaseInfo = getUserBaseInfo(phoneNo, contractNo, true, provinceId);
			
			//获取被支付账户滞纳金优惠率
			long delayFavourRate = 0;
			
			inTransCfmMap = new HashMap<String, Object>();
			safeAddToMap(inTransCfmMap, "Header", inDto.getHeader());
			safeAddToMap(inTransCfmMap, "TRANS_TYPE_OBJ", transType); //转账类型实例化对象
			safeAddToMap(inTransCfmMap, "TRANS_IN", inTransBaseInfo);  //转入账户基本信息
			safeAddToMap(inTransCfmMap, "TRANS_OUT", outTransBaseInfo); //转出账户基本信息
			safeAddToMap(inTransCfmMap, "BOOK_IN", bookIn); //入账实体
			safeAddToMap(inTransCfmMap, "OP_TYPE", opType); //转账类型
			
			/*转账*/
			long transSn = payManage.transBalance(inTransCfmMap);
			
			//用户冲销欠费
			inTransCfmMap = new HashMap<String, Object>();
			safeAddToMap(inTransCfmMap, "Header", inDto.getHeader());
			safeAddToMap(inTransCfmMap, "CONTRACT_NO",contractNo);
			safeAddToMap(inTransCfmMap, "PAY_SN", transSn);
			safeAddToMap(inTransCfmMap, "PHONE_NO", contractNo);
			safeAddToMap(inTransCfmMap, "LOGIN_NO", bookIn.getLoginNo());
			safeAddToMap(inTransCfmMap, "OP_CODE", bookIn.getOpCode());
			safeAddToMap(inTransCfmMap, "GROUP_ID", bookIn.getGroupId());
			safeAddToMap(inTransCfmMap, "PAY_PATH", bookIn.getPayPath());
			safeAddToMap(inTransCfmMap, "DELAY_FAVOUR_RATE", "0");
			writeOffer.doWriteOff(inTransCfmMap);
			
			//实时开机
			payOpener.doConUserOpen(inDto.getHeader(), inTransBaseInfo, bookIn, inDto.getProvinceId());
			
			//发送短信
		}
		
		//记录营业员操作日志
		/* 转出号码：记录营业员操作日志 */
		LoginOprEntity outTransOpr = new LoginOprEntity();
		outTransOpr.setBrandId(outTransBaseInfo.getBrandId());
		outTransOpr.setIdNo(outTransBaseInfo.getIdNo());
		outTransOpr.setLoginGroup(groupId);
		outTransOpr.setLoginNo(loginNo);
		outTransOpr.setLoginSn(foreignSn);
		outTransOpr.setOpCode(opCode);
		outTransOpr.setOpTime(curTime);
		outTransOpr.setPayFee((-1) * shouldPay);
		outTransOpr.setPhoneNo(outTransBaseInfo.getPhoneNo());
		outTransOpr.setRemark(opNote);
		outTransOpr.setPayType("0");
		outTransOpr.setTotalDate(Integer.parseInt(totalDate));
		record.saveLoginOpr(outTransOpr);
		
		S8078CfmOutDTO outDto = new S8078CfmOutDTO();
		return outDto;
	}
	
	/* 获取用户基本信息 */
	private PayUserBaseEntity getUserBaseInfo(String inPhoneNo, long inContractNo, boolean isTransInFlag, String provinceId) {
		String phoneNo = inPhoneNo;
		long contractNo = inContractNo;
		String conGroup="";
		
		log.info("getUserBaseInfo-->phoneNo:"+phoneNo+",contractNo"+ contractNo);
		
		long idNo = 0;
		String brandId = "";

		/* 获取用户信息 */
		UserInfoEntity  userEntity = user.getUserInfo(phoneNo);
		idNo = userEntity.getIdNo();
		if (contractNo == 0) {
			contractNo = userEntity.getContractNo();
		}
		brandId = userEntity.getBrandId();
			
		/*获取账户信息*/
		ContractInfoEntity conEntity = account.getConInfo(inContractNo);
		conGroup=conEntity.getGroupId();

		//查询账户地市归属信息
		ChngroupRelEntity groupEntity = group.getRegionDistinct(conGroup, "2", provinceId);
		String regionId = groupEntity.getRegionCode();
		
		// 出参信息
		PayUserBaseEntity userBaseInfo = new PayUserBaseEntity();
		userBaseInfo.setBrandId(brandId);
		userBaseInfo.setContractNo(contractNo);
		userBaseInfo.setIdNo(idNo);
		userBaseInfo.setPhoneNo(phoneNo);
		userBaseInfo.setRegionId(regionId);
		userBaseInfo.setUserGroupId(conGroup);
		userBaseInfo.setNetFlag(true);
		
		return userBaseInfo;
	}

	/**
	 * @return the user
	 */
	public IUser getUser() {
		return user;
	}

	/**
	 * @param user the user to set
	 */
	public void setUser(IUser user) {
		this.user = user;
	}

	/**
	 * @return the balance
	 */
	public IBalance getBalance() {
		return balance;
	}

	/**
	 * @param balance the balance to set
	 */
	public void setBalance(IBalance balance) {
		this.balance = balance;
	}

	/**
	 * @return the account
	 */
	public IAccount getAccount() {
		return account;
	}

	/**
	 * @param account the account to set
	 */
	public void setAccount(IAccount account) {
		this.account = account;
	}

	/**
	 * @return the cust
	 */
	public ICust getCust() {
		return cust;
	}

	/**
	 * @param cust the cust to set
	 */
	public void setCust(ICust cust) {
		this.cust = cust;
	}

	/**
	 * @return the control
	 */
	public IControl getControl() {
		return control;
	}

	/**
	 * @param control the control to set
	 */
	public void setControl(IControl control) {
		this.control = control;
	}

	/**
	 * @return the group
	 */
	public IGroup getGroup() {
		return group;
	}

	/**
	 * @param group the group to set
	 */
	public void setGroup(IGroup group) {
		this.group = group;
	}

	/**
	 * @return the record
	 */
	public IRecord getRecord() {
		return record;
	}

	/**
	 * @param record the record to set
	 */
	public void setRecord(IRecord record) {
		this.record = record;
	}

	/**
	 * @return the payManage
	 */
	public IPayManage getPayManage() {
		return payManage;
	}

	/**
	 * @param payManage the payManage to set
	 */
	public void setPayManage(IPayManage payManage) {
		this.payManage = payManage;
	}

	/**
	 * @return the writeOffer
	 */
	public IWriteOffer getWriteOffer() {
		return writeOffer;
	}

	/**
	 * @param writeOffer the writeOffer to set
	 */
	public void setWriteOffer(IWriteOffer writeOffer) {
		this.writeOffer = writeOffer;
	}

	/**
	 * @return the payOpener
	 */
	public IPayOpener getPayOpener() {
		return payOpener;
	}

	/**
	 * @param payOpener the payOpener to set
	 */
	public void setPayOpener(IPayOpener payOpener) {
		this.payOpener = payOpener;
	}

	/**
	 * @return the transFactory
	 */
	public TransFactory getTransFactory() {
		return transFactory;
	}

	/**
	 * @param transFactory the transFactory to set
	 */
	public void setTransFactory(TransFactory transFactory) {
		this.transFactory = transFactory;
	}
	
	

}
