package com.sitech.acctmgr.atom.impl.invoice;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.sitech.acctmgr.atom.domains.invoice.BalInvauditInfo;
import com.sitech.acctmgr.atom.domains.invoice.BalTaxinvoicePre;
import com.sitech.acctmgr.atom.dto.invoice.S2318QueryInDTO;
import com.sitech.acctmgr.atom.dto.invoice.S2318QueryOutDTO;
import com.sitech.acctmgr.atom.entity.inter.IInvoice;
import com.sitech.acctmgr.common.AcctMgrBaseService;
import com.sitech.acctmgr.inter.invoice.I2318;
import com.sitech.jcfx.anno.ParamType;
import com.sitech.jcfx.anno.ParamTypes;
import com.sitech.jcfx.dt.in.InDTO;
import com.sitech.jcfx.dt.out.OutDTO;

@ParamTypes({ @ParamType(c = S2318QueryInDTO.class, m = "query", oc = S2318QueryOutDTO.class) })
public class S2318 extends AcctMgrBaseService implements I2318 {

	private IInvoice invoice;
	@Override
	public OutDTO query(InDTO inParam) {
		S2318QueryInDTO inDto = (S2318QueryInDTO) inParam;

		String invCode = inDto.getInvCode();
		String invNo = inDto.getInvNo();
		// 根据发票代码和发票号码查询打印流水
		Map<String, Object> inMap = new HashMap<String, Object>();
		inMap.put("INV_NO", invNo);
		inMap.put("INV_CODE", invCode);
		List<BalInvauditInfo> auditList = invoice.getAuditInfoList(inMap);
		List<BalTaxinvoicePre> taxInvoicePreList = new ArrayList<BalTaxinvoicePre>();
		// 获取发票流水
		for (BalInvauditInfo auditInfo : auditList) {
			String printSn = auditInfo.getPrintSn();
			// 查询预开票记录
			inMap = new HashMap<String, Object>();
			inMap.put("INVOICE_ACCEPT", printSn);
			inMap.put("STATUS", "p");
			inMap.put("CHG_FLAG", "1");
			List<BalTaxinvoicePre> taxInvoicePreListTmp = invoice.taxInvoicePre(inMap);
			taxInvoicePreList.addAll(taxInvoicePreListTmp);
		}
		S2318QueryOutDTO outDto = new S2318QueryOutDTO();
		outDto.setTaxInvoicePreList(taxInvoicePreList);
		return outDto;
	}

	public IInvoice getInvoice() {
		return invoice;
	}

	public void setInvoice(IInvoice invoice) {
		this.invoice = invoice;
	}

}
