package com.sitech.acctmgr.atom.impl.free;

import java.util.List;
import java.util.Map;

import com.sitech.acctmgr.atom.domains.query.FreeMinBill;
import com.sitech.acctmgr.atom.domains.user.UserInfoEntity;
import com.sitech.acctmgr.atom.dto.free.SMonthFreeQueryInDTO;
import com.sitech.acctmgr.atom.dto.free.SMonthFreeQueryOutDTO;
import com.sitech.acctmgr.atom.dto.free.SYearFreeQueryOutDTO;
import com.sitech.acctmgr.atom.entity.inter.IFreeDisplayer;
import com.sitech.acctmgr.atom.entity.inter.IUser;
import com.sitech.acctmgr.common.AcctMgrBaseService;
import com.sitech.acctmgr.common.utils.DateUtils;
import com.sitech.acctmgr.inter.free.IMonthFree;
import com.sitech.jcfx.anno.ParamType;
import com.sitech.jcfx.anno.ParamTypes;
import com.sitech.jcfx.dt.in.InDTO;
import com.sitech.jcfx.dt.out.OutDTO;

/**
 * Created by wangyla on 2016/7/22.
 */
@ParamTypes({@ParamType(c = SMonthFreeQueryInDTO.class, m = "query", oc = SMonthFreeQueryOutDTO.class)})
public class SMonthFree extends AcctMgrBaseService implements IMonthFree {

	private IUser user;
	private IFreeDisplayer freeDisplayer;
	
    @Override
    public OutDTO query(InDTO inParam){
        SMonthFreeQueryInDTO inDTO = (SMonthFreeQueryInDTO) inParam;
        log.debug("inDto=" + inDTO.getMbean());

        String phoneNo = inDTO.getPhoneNo();
        
        UserInfoEntity userInfo = user.getUserEntityByPhoneNo(phoneNo, true);
        long idNo = userInfo.getIdNo();
        
        List<FreeMinBill> freeList = freeDisplayer.getFreeDetailList(phoneNo, DateUtils.getCurYm(), "0");
        Map<String, Long> freeMap = freeDisplayer.getFreeTotalMap(freeList);
        SMonthFreeQueryOutDTO outDTO = new SMonthFreeQueryOutDTO();
//        outDTO.setTotalFee(favour1);
//        outDTO.setUsedFee(usedFavour);
//        outDTO.setRemainFee(favour1 - usedFavour);

        outDTO.setSmsTotal(freeMap.get("SMS_TOTAL"));
        outDTO.setSmsUsed(freeMap.get("SMS_USED"));
        outDTO.setSmsRemain(freeMap.get("SMS_REMAIN"));
        outDTO.setTimeTotal(freeMap.get("VOICE_TOTAL"));
        outDTO.setTimeUsed(freeMap.get("VOICE_USED"));
        outDTO.setTimeRemain(freeMap.get("VOICE_REMAIN"));

        log.debug("outDto=" + outDTO.toJson());
        return outDTO;
    }

	public IUser getUser() {
		return user;
	}

	public void setUser(IUser user) {
		this.user = user;
	}

	public IFreeDisplayer getFreeDisplayer() {
		return freeDisplayer;
	}

	public void setFreeDisplayer(IFreeDisplayer freeDisplayer) {
		this.freeDisplayer = freeDisplayer;
	}
    
}
