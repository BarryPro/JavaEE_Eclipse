package com.sitech.acctmgr.atom.busi.invoice;

import java.io.UnsupportedEncodingException;
import java.lang.reflect.Method;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.collections.MapUtils;
import org.dom4j.Document;
import org.dom4j.DocumentHelper;
import org.dom4j.Element;

import com.sitech.acctmgr.atom.busi.invoice.inter.IElecInvoice;
import com.sitech.acctmgr.atom.domains.invoice.PrintDataBlob;
import com.sitech.acctmgr.atom.domains.invoice.elecInvoice.InvQryParam;
import com.sitech.acctmgr.atom.domains.invoice.elecInvoice.InvoiceDdInfo;
import com.sitech.acctmgr.atom.domains.invoice.elecInvoice.InvoiceDetailInfo;
import com.sitech.acctmgr.atom.domains.invoice.elecInvoice.InvoiceHeaderInfo;
import com.sitech.acctmgr.atom.domains.invoice.elecInvoice.InvoiceInfo;
import com.sitech.acctmgr.atom.domains.invoice.elecInvoice.InvoiceXhfInfo;
import com.sitech.acctmgr.atom.entity.inter.IControl;
import com.sitech.acctmgr.atom.entity.inter.IInvoice;
import com.sitech.acctmgr.common.AcctMgrError;
import com.sitech.acctmgr.common.BaseBusi;
import com.sitech.acctmgr.common.constant.CommonConst;
import com.sitech.acctmgr.common.utils.BeanToXmlUtils;
import com.sitech.acctmgr.common.utils.DateUtils;
import com.sitech.acctmgr.common.utils.HbaseUtils;
import com.sitech.acctmgr.common.utils.InstantiationUtils;
import com.sitech.acctmgr.common.utils.ValueUtils;
import com.sitech.acctmgrint.atom.busi.intface.IBusiMsgSnd;
import com.sitech.acctmgrint.atom.busi.intface.IShortMessage;
import com.sitech.common.CrossEntity;
import com.sitech.common.utils.StringUtils;
import com.sitech.jcf.core.exception.BusiException;
import com.sitech.jcfx.dt.MBean;

public class ElecInvoice extends BaseBusi implements IElecInvoice {
	
	private IControl control;
	private IShortMessage shortMessage;
	private IBusiMsgSnd busiMsgSnd;
	private IInvoice invoice;

	@Override
	public Map<String, String> EInvPrintSub(InvoiceInfo eleInvoice, InvoiceXhfInfo xhfInfo, String loginNo, int sendMsgFlag) {
		Map<String, String> outPut = new HashMap<String, String>();
		String requestSn = eleInvoice.getInvoiceHeader().getFpqqlsh();
		
		String invNo="";
		String invCode="";
		// 获取同步异步配置 0 同步 ，1异步
		String asynFlag = "0";
		asynFlag = control.getPubCodeValue(3015, "8000", "0");
		// 调用开具
		Map<String, String> eaiResult = getEleInvoiceIssue(eleInvoice, xhfInfo, asynFlag);

		// 对返回报文转码
		String returnMsgByPd = "";
		if (eaiResult != null) {
			returnMsgByPd = eaiResult.toString();
			log.debug("===> reQuestSn : {},调用开具转码响应结果:{} ", requestSn, returnMsgByPd);
		}

		// 解析返回报文
		String retCode = MapUtils.getString(eaiResult, "returnCode", "8888");
		String returnMsg = "";
		try {
			// 处理返回信息
			if (StringUtils.isNotEmptyOrNull(eaiResult.get("returnMessage"))) {
				returnMsg = new String(eaiResult.get("returnMessage").getBytes("GBK"), "UTF-8");
				log.debug("===> reQuestSn : {},调用开具返回信息:{} ", requestSn, returnMsg);
			}

		} catch (Exception e) {
			e.printStackTrace();
			log.error("===> reQuestSn : " + requestSn + ",调用开具returnMsg :" + eaiResult.get("returnMessage"));
		}

		if (!retCode.equals("0000")) {
			log.error("===> reQuestSn : {},航信开具失败，错误代码:{} ，错误信息:{}", requestSn, retCode, returnMsg);
			MapUtils.safeAddToMap(outPut, "RETURN_CODE", "0002");
			MapUtils.safeAddToMap(outPut, "RETURN_MSG", "航信开具失败，错误代码：" + retCode + "，错误信息：" + returnMsg);
			MapUtils.safeAddToMap(outPut, "TIME", eaiResult.get("TIME"));
			return outPut;
		}

		// 对前面事务提交。如果下面处理content失败，将走异步流程。
		Connection conn = baseDao.getConnection();
		try {
			conn.commit();
		} catch (SQLException e) {
			e.printStackTrace();
			log.error("===> reQuestSn : {},提交失败", requestSn);
		}

		// 取当前年月时间===>与异步兼容更新发票表数据
		String sCurTime = DateUtils.getCurDate("yyyyMMddHHmmss");

		String phoneNo = eleInvoice.getInvoiceHeader().getGhfsj();
		String url = "http://www.jl.10086.cn/service/operate/invoice/QryPreInv.jsp?phone=" + phoneNo + "&seq=" + requestSn;
		if (asynFlag.equals("0")) {
			String content = MapUtils.getString(eaiResult, "content", "9999");
			if ("9999".equals(content)) {
				log.error("===> reQuestSn : " + requestSn + ",调用开具,返回的content内容非法");
			} else {
				log.debug("===> content [" + content + "]");
				try {
					InvQryParam qryParam = EInvcContentDeal(content);
					invNo=qryParam.getFp_hm();
					invCode=qryParam.getFp_dm();
					// 入pdf表
					invoice.insertPDFInfo(requestSn, qryParam.getPdf_file(), qryParam.getFp_dm(), qryParam.getFp_hm(), loginNo);
					// 短信推送
					if(sendMsgFlag==0){
						sendSms(phoneNo, url);
					}
					// 发送139邮箱
					Map<String, Object> inMap = new HashMap<String, Object>();
					inMap.put("REQUEST_SN", requestSn);
					inMap.put("YEAR_MONTH", DateUtils.getCurYm());
					inMap.put("PRINT_SN", eleInvoice.getInvoiceDd().getDdh());
					inMap.put("PRINT_ARRAY", "1");
					sendMail(inMap);
				} catch (Exception e) {
					e.printStackTrace();
					// 只打印，不报错。走异步流程处理
					log.error("===> reQuestSn : " + requestSn + ",处理content失败：[" + content + "]");

					try {
						conn.rollback();
					} catch (SQLException ee) {
						ee.printStackTrace();
						log.error("===> reQuestSn : {},回滚失败", requestSn);
					}
				}
			}
		}

		// 返回map
		MapUtils.safeAddToMap(outPut, "RETURN_CODE", retCode);
		MapUtils.safeAddToMap(outPut, "RETURN_MSG", returnMsg);
		MapUtils.safeAddToMap(outPut, "TIME", eaiResult.get("TIME"));
		MapUtils.safeAddToMap(outPut, "INV_NO", invNo);
		MapUtils.safeAddToMap(outPut, "INV_CODE", invCode);
		return outPut;
	}

	@Override
	public String getInvPdfFile(String requestSn, String phoneNo) {

		String invcYmTmp = requestSn.substring(1, 7); // 发票年月
		int curYm = DateUtils.getCurYm();
		String oracleYmCnt = control.getPubCodeValue(3015, "82851", "0"); // oracle数据库保存月数，当月算一个月
		String hbaseYmCnt = control.getPubCodeValue(3015, "82852", "0"); // hbase数据库保存月数，当月算一个月

		String invStr = null;
		long invYm = Long.parseLong(invcYmTmp);
		long monthCnt = (curYm / 100) * 12 + (curYm % 100) - (invYm / 100) * 12 - (invYm % 100);

		if (monthCnt < Long.parseLong(oracleYmCnt)) {
			// 从bal_einvpdf_info表获取PDF文件
			Map<String, Object> inParam = new HashMap<String, Object>();
			inParam.put("YEAR_MONTH", requestSn.substring(1, 7));// requestSn以 B20161013形式开头
			inParam.put("REQUEST_SN", requestSn);
			PrintDataBlob printData = (PrintDataBlob) baseDao.queryForObject("bal_einvpdf_info.qPdfInfo", inParam);
			if (printData.getPrintContent() != null) {
				invStr = new String(printData.getPrintContent());
			} else {
				throw new BusiException(AcctMgrError.getErrorCode("0000", "60002"), "未查询到发票数据！");
			}
		} else if (monthCnt < Long.parseLong(hbaseYmCnt)) {
			// 从Hbase获取PDF文件

			// 生成hbase 表名
			StringBuilder tablename = new StringBuilder();
			tablename.append("einvoice_").append(requestSn.substring(1, 7));// invReqSn以 B20161013形式开头

			// 生成hbase key值
			StringBuilder key = new StringBuilder();
			key.append(StringUtils.reverse(phoneNo)).append(requestSn);// 手机号码必须反序，hbase用key值前3位做域划分

			log.debug("tablename：" + tablename.toString() + ", key:" + key.toString());

			// 查询hbase
			long startTime = Long.parseLong(DateUtils.getCurDate("yyyyMMddHHmmssSSS"));
			try {
				invStr = HbaseUtils.getValue(tablename.toString(), key.toString());
				log.debug("invStr：" + invStr);
			} catch (Exception e) {
				throw new BusiException(AcctMgrError.getErrorCode("0000", "60001"), "查询过程出错：Hbase访问问题！");
			}
			long endTime = Long.parseLong(DateUtils.getCurDate("yyyyMMddHHmmssSSS"));

			log.debug("查询Hbase总用时-->" + (endTime - startTime) + "ms");
			if ((endTime - startTime) > 200) {
				log.error("查询Hbase总用时-->" + (endTime - startTime) + "ms");
			}

			// 验证返回串
			if (com.sitech.common.utils.StringUtils.isEmptyOrNull(invStr)) {
				throw new BusiException(AcctMgrError.getErrorCode("0000", "60002"), "未查询到发票数据！");
			}
		} else {
			throw new BusiException(AcctMgrError.getErrorCode("0000", "60002"), "未查询到发票数据！");
		}

		return invStr;
	}

	@Override
	public String getInvFile(String requestSn, String phoneNo, String fileType) {
		// 获取原始PDF文件
		String pdfFile = getInvPdfFile(requestSn, phoneNo);

		if (fileType.equals("0")) {
			return pdfFile;
		}

		// 生成发送报文
		MBean serviceMBean = new MBean();
		String dpi = "150"; // 待转换图像dpi值
		String zipCode = "0"; // 0,1是否压缩
		// String fileType = "1"; //1, 黑白PDF 2， PNG图片 3， PDF&PNG

		String content = "<REQUEST_PDF2IMAGE>" + "<dpi>" + dpi + "</dpi>" + "<zipCode>" + zipCode + "</zipCode>" + "<fileType>" + fileType
				+ "</fileType>" + "<pdfContent>" + pdfFile + "</pdfContent>" + "</REQUEST_PDF2IMAGE>";
		serviceMBean.setBody("content", content);

		// 调用航信接口
		String sEaiServe = "EAI_ElecInvoicePrint_SYNPDF";
		Map<String, String> EaiResult = CrossEntity.callService(sEaiServe, serviceMBean);

		// 对返回报文转码
		String returnMsgByPd = "";
		if (EaiResult != null) {
			try {
				returnMsgByPd = new String(EaiResult.toString().getBytes("GBK"), "UTF-8");
			} catch (UnsupportedEncodingException e1) {
				e1.printStackTrace();
			}
			log.debug("===> reQuestSn : {},调用开具转码响应结果:{} ", requestSn, returnMsgByPd);
		}

		String response = MapUtils.getString(EaiResult, "return", "8888");
		if (response.equals("8888")) {
			log.error("===> reQuestSn : " + requestSn + ",调用黑白打印没有返回结果");
			return "";
		}

		/**
		 * 解析XML <?xml version="1.0" encoding="UTF-8" ?> <RESPONSE_PDF2IMAGE> <returnCode>0000</returnCode> <returnMessage>6L2s5o2i5oiQ5Yqf</returnMessage> <zipCode>0</zipCode> <pdfFile>xxxx</pdfFile> <fileType>1</fileType> <pdfPages size="0"/> <pdfPages size="1"> <pdfPage> <pageIndex>0</pageIndex> <imageContent>编码后PNG文件数据</imageContent> <imageWidth>2539</imageWidth> <imageHeight>1642</imageHeight> </pdfPage> </pdfPages> </RESPONSE_PDF2IMAGE>
		 */
		int beginIndex = 0;
		int endIndex = 0;
		beginIndex = response.indexOf("<returnCode>");
		endIndex = response.indexOf("</returnCode>");
		String retCode = response.substring(beginIndex + 12, endIndex);

		beginIndex = response.indexOf("<returnMessage>");
		endIndex = response.indexOf("</returnMessage>");
		String returnMsg = response.substring(beginIndex + 15, endIndex);

		if (!retCode.equals("0000")) {
			log.error("===> reQuestSn : " + requestSn + ",调用黑白打印错误：" + returnMsg);
			return "";
		}

		beginIndex = response.indexOf("<pdfFile>");
		endIndex = response.indexOf("</pdfFile>");
		String retPdfFile = response.substring(beginIndex + 9, endIndex);

		if (fileType.equals("1")) {
			return retPdfFile;
		}

		beginIndex = response.indexOf("<imageContent>");
		endIndex = response.indexOf("</imageContent>");
		String retPngFile = response.substring(beginIndex + 14, endIndex);

		return retPngFile;

	}

	@Override
	public void sendMail(Map<String, Object> inParam) {
		String requestSn = inParam.get("REUQEST_SN").toString();
		long yearMonth = Long.parseLong(inParam.get("YEAR_MONTH").toString());
		long printSn = Long.parseLong(inParam.get("PRINT_SN").toString());
		long printArray = Long.parseLong(inParam.get("PRINT_ARRAY").toString());
		String userMailStr = "";

		Map<String, Object> inMap = new HashMap<String, Object>();
		MapUtils.safeAddToMap(inMap, "REQUEST_SN", requestSn);
		MapUtils.safeAddToMap(inMap, "YEAR_MONTH", yearMonth);
		MapUtils.safeAddToMap(inMap, "PRINT_SN", printSn);
		MapUtils.safeAddToMap(inMap, "PRINT_ARRAY", printArray);
		Map<String, Object> outFeeMap = (Map<String, Object>) baseDao.queryForObject("bal_invprint_info.qSendMail", inMap);
		Map<String, Object> outUserMap = (Map<String, Object>) baseDao.queryForObject("ur_user_info.qUserInfo", outFeeMap);

		// 通过CRM获取邮箱订购关系
		inMap.clear();
		MapUtils.safeAddToMap(inMap, "ID_NO", outUserMap.get("ID_NO"));
		Map<String, Object> outMailMap = (Map<String, Object>) baseDao.queryForObject("cs_cssbusimail_info.qryUserMail", inMap);
		if (outMailMap.size() == 0) {
			log.error("139邮箱未关联到CRM侧订购信息");
			return;
		} else {
			// 判断是否推送
			if (outMailMap.get("SEND_FLAG").toString().equals("1")) {
				log.error("139邮箱设置为不推送邮件");
				return;
			} else {// 后续需要联调确认是否所有类型邮箱均传送到平台就能行推送
				userMailStr = outMailMap.get("MAIL_NAME").toString();
			}
		}

		String pdf = getInvPdfFile(requestSn, outFeeMap.get("PHONE_NO").toString());
		// 封装交互报文
		MBean mail = new MBean();
		mail.setBody("DZFPYJTS_KHXX.KHSJHM", outFeeMap.get("PHONE_NO").toString());
		mail.setBody("DZFPYJTS_KHXX.KHBS", outUserMap.get("CUST_ID").toString());
		mail.setBody("DZFPYJTS_KHXX.KHMC", "");
		mail.setBody("DZFPYJTS_KHXX.KHLX", "1");
		mail.setBody("DZFPYJTS_KHXX.KHMC", userMailStr);
		mail.setBody("DZFPYJTS_KHXX.KHGSD", outUserMap.get("CONTRACT_NO").toString().substring(0, 4));
		mail.setBody("DZFPYJTS_KHXX.KHQD", outFeeMap.get("LOGIN_NO").toString().equals("www000") ? "5" : "1");// 客户发起渠道
		mail.setBody("DZFPYJTS_FPXX.KPSJ", Long.parseLong(String.valueOf(outFeeMap.get("OP_TIME") + "0")));
		mail.setBody("DZFPYJTS_FPXX.KPQD", outFeeMap.get("LOGIN_NO").toString().equals("www000") ? "5" : "1");// 开票渠道
		mail.setBody("DZFPYJTS_FPXX.KPXM", outFeeMap.get("PRINT_FEE").toString());
		mail.setBody("DZFPYJTS_FPXX.KPMXPM", "发票信息");
		mail.setBody("DZFPYJTS_FPXX.KPPDFWJ", pdf);
		mail.setBody("DZFPYJTS_FPXX.FPJYM", "");// MD5编码
		mail.setBody("DZFPYJTS_FPXX.SFBS", "431");
		mail.setBody("DZFPYJTS_FPXX.YWLSH",
 "DZFP_431_" + outFeeMap.get("PHONE_NO").toString() + "_*_" + DateUtils.getCurDate("yyyyMMddhhmmss"));

		// 获取同步异步配置 0 同步 ，1异步

		String sEaiServe = "EAI_ElecInvoicePrint_MAIL";

		// 调用PD
		log.debug("===> reQuestSn : {},调用139平台请求报文:{} ", requestSn, mail);
		Map<String, String> EaiResult = CrossEntity.callService(sEaiServe, mail);
		log.debug("===> reQuestSn : {},调用139平台响应结果:{} ", requestSn, EaiResult);

		// 对返回报文转码
		String returnMsgByPd = "";
		if (EaiResult != null) {
			try {
				returnMsgByPd = new String(EaiResult.toString().getBytes("GBK"), "UTF-8");
			} catch (UnsupportedEncodingException e1) {
				e1.printStackTrace();
				log.error("===> reQuestSn : {},调用139平台响应结果:{} ", requestSn, EaiResult);
			}
			log.debug("===> reQuestSn : {},调用139平台转码响应结果:{} ", requestSn, returnMsgByPd);
		}

		// 解析返回报文
		String retCode = MapUtils.getString(EaiResult, "returnCode", "8888");
		String returnMsg = "";
		try {
			// 处理返回信息
			if (StringUtils.isNotEmptyOrNull(EaiResult.get("returnMessage"))) {
				returnMsg = new String(EaiResult.get("returnMessage").getBytes("GBK"), "UTF-8");
				log.debug("===> reQuestSn : {},调用139平台返回信息:{} ", requestSn, returnMsg);
			}

		} catch (Exception e) {
			e.printStackTrace();
			log.error("===> reQuestSn : " + requestSn + ",调用139平台returnMsg :" + EaiResult.get("returnMessage"));
		}

		if (!retCode.equals("0000")) {
			log.error("===> reQuestSn : {},调用139平台失败，错误代码:{} ，错误信息:{}", requestSn, retCode, returnMsg);
		}
	}

	// 发送短信： 尊敬的用户您好，您申请的电子发票已开具成功，请您通过XXXX网址进行查询和打印，具体详情可咨询10086。
	@Override
	public void sendSms(String phoneNo, String url) {

		Map<String, Object> data = new HashMap<String, Object>();
		data.put("URL", url);
		MBean inMessage = new MBean();
		inMessage.addBody("TEMPLATE_ID", "31320080");
		inMessage.addBody("PHONE_NO", phoneNo);
		inMessage.addBody("LOGIN_NO", "system");
		inMessage.addBody("OP_CODE", "0000");
		inMessage.addBody("CHECK_FLAG", true);
		inMessage.addBody("DATA", data);
		inMessage.addBody("SEND_FLAG", 0);
		log.error("======>手机号:" + phoneNo + ",发送短信内容：" + inMessage.toString());
		shortMessage.sendSmsMsg(inMessage);

	}

	@Override
	public void smsSendAgain(Map<String, Object> inParamMap) {
		String phoneNo = inParamMap.get("phoneNo").toString();
		String requestSn = inParamMap.get("requestSn").toString();

		// 根据requestSn 查询URL
		Map<String, Object> inMap = new HashMap<String, Object>();
		inMap.put("YEAR_MONTH", requestSn.substring(1, 7));// requestSn以 B20161013形式开头
		inMap.put("REQUEST_SN", requestSn);
		Map<String, Object> urlMap = (Map<String, Object>) baseDao.queryForObject("bal_einvpdf_info.qWebUrlInfo", inMap);
		String url = String.valueOf(urlMap.get("WEB_URL"));

		// 补发短信
		sendSms(phoneNo, url);

		return;
	}

	@Override
	public void saveCrmElecInvoice(Map<String, Object> inParamMap) {
		Map<String, Object> inMap = new HashMap<String, Object>();

		// 插入CRM电子发票记录表
		baseDao.insert("in_einvoiceprint_info.iElecInvPrintInfo", inParamMap);

		// 红票，更新原蓝票的state=4
		if (inParamMap.get("INV_TYPE").toString().equals("2")) { // 红票
			MapUtils.safeAddToMap(inMap, "STATE", "4");
			MapUtils.safeAddToMap(inMap, "REQUEST_SN", inParamMap.get("OLD_REQUEST_SN").toString());
			baseDao.update("in_einvoiceprint_info.upEinvCrmInfo", inMap);
		}

		// 同步接口需要解析content,并处理相关表数据
		if (inParamMap.get("STATE").toString().equals("1")) { // state为1代表同步接口 为0是异步接口
			String content = inParamMap.get("CONTENT").toString();
			if (content == null) {
				throw new BusiException(AcctMgrError.getErrorCode("0000", "01010"), "同步接口content为空");
			}

			try {
				EInvcContentDealCrm(inParamMap, content);
			} catch (Exception e) {
				e.printStackTrace();
				throw new BusiException(AcctMgrError.getErrorCode("0000", "01010"), "处理content内容失败");
			}
		}
	}

	@Override
	public void EInvcContentDealCrm(Map<String, Object> inParamMap, String content) throws Exception {
		Map<String, Object> inMap = null;
		Object invQryParam = null;
		Document doc = null;
		Connection conn = null;
		conn = baseDao.getConnection();

		// 解析contentXML报文，并保存在InvQryParam实体里
		// try {
		doc = DocumentHelper.parseText(content);

		Element rootElt = doc.getRootElement();
		List<Element> listElement = rootElt.elements();
		Class[] cArg = new Class[1];
		cArg[0] = String.class;
		if (listElement != null && listElement.size() > 0) {
			Class clazz = Class.forName("com.sitech.acctmgr.atom.domains.InvQryParam");
			invQryParam = clazz.newInstance();
			for (Element node : listElement) {
				String methodName = "set" + node.getName().substring(0, 1) + node.getName().substring(1).toLowerCase();
				Method func = clazz.getDeclaredMethod(methodName, cArg);
				func.invoke(invQryParam, node.getTextTrim());
			}
		}

		InvQryParam imp = (InvQryParam) invQryParam;

		String sCurTime = DateUtils.getCurDate(DateUtils.DATE_FORMAT_YYYYMMDDHHMISS);
		String sYearMonth = DateUtils.getCurYm() + "";
		String url = "http://www.jl.10086.cn/service/operate/invoice/QryPreInv.jsp?phone=" + inParamMap.get("PHONE_NO").toString() + "&seq="
				+ inParamMap.get("REQUEST_SN").toString();

		// 往BAL_EINVPDF_INFO表插入数据
		inMap = new HashMap<String, Object>();
		inMap.put("YEAR_MONTH", inParamMap.get("REQUEST_SN").toString().substring(1, 7));// requestSn以 B20161013形式开头
		inMap.put("REQUEST_SN", inParamMap.get("REQUEST_SN").toString());
		inMap.put("PDFFILEBYTE", imp.getPdf_file().getBytes());
		baseDao.insert("bal_einvpdf_info.iEinvPdfInfo", inMap);

		// 往BAL_EINVPDF_REL表插入数据
		inMap = new HashMap<String, Object>();
		inMap.put("YEAR_MONTH", inParamMap.get("REQUEST_SN").toString().substring(1, 7));// requestSn以 B20161013形式开头
		inMap.put("REQUEST_SN", inParamMap.get("REQUEST_SN").toString());
		inMap.put("PRINT_SN", inParamMap.get("PRINT_SN").toString());
		inMap.put("PRINT_ARRAY", "1");
		inMap.put("PHONE_NO", inParamMap.get("PHONE_NO").toString());
		inMap.put("INVREQ_TIME", sCurTime);
		inMap.put("REMARK", "syn");
		inMap.put("WEB_URL", url);
		baseDao.insert("bal_einvpdf_info.iEinvPdfRel", inMap);

		// 更新发票代码，发票号码，发票url
		inMap = new HashMap<String, Object>();
		inMap.put("INV_CODE", imp.getFp_dm());
		inMap.put("INV_NO", imp.getFp_hm());
		inMap.put("STATE", "1");
		inMap.put("INVREQ_SN", inParamMap.get("REQUEST_SN").toString());
		inMap.put("PHONE_NO", inParamMap.get("PHONE_NO").toString());
		baseDao.update("in_einvoiceprint_info.upEinvCrmInfoInvc", inMap);

		// 插入hbase
		inMap = new HashMap<String, Object>();
		inMap.put("INVREQ_SN", inParamMap.get("REQUEST_SN").toString());
		inMap.put("PHONE_NO", inParamMap.get("PHONE_NO").toString());
		inMap.put("PDFFILE", imp.getPdf_file());
		try {
			// conn.commit();
			// insertHbase(inMap, conn);
			// conn.commit();
		} catch (Exception e) {
			e.printStackTrace();
		}

		// 发送短信
		sendSms(inParamMap.get("PHONE_NO").toString(), url);

		// 推送139邮箱
		Map<String, Object> mailMap = new HashMap<String, Object>();
		MapUtils.safeAddToMap(mailMap, "REQUEST_SN", inParamMap.get("REQUEST_SN").toString());
		MapUtils.safeAddToMap(mailMap, "YEAR_MONTH", inParamMap.get("REQUEST_SN").toString().substring(1, 7));
		MapUtils.safeAddToMap(mailMap, "PRINT_SN", inParamMap.get("PRINT_SN").toString());
		MapUtils.safeAddToMap(mailMap, "PRINT_ARRAY", "1");
		// sendMail(mailMap);

		// 异步模式，后台程序调用此方法会传ASYN参数。 需要给CRM发送业务工单
		if (inParamMap.get("ASYN") != null) {
			try {
				// 存入发票代码,号码
				MapUtils.safeAddToMap(inParamMap, "INV_CODE", imp.getFp_dm());
				MapUtils.safeAddToMap(inParamMap, "INV_NO", imp.getFp_hm());

				sendOrderToCRM(inParamMap);
			} catch (Exception e) {
				e.printStackTrace();
			}
		}

	}

	@Override
	public void sendOrderToCRM(Map<String, Object> inmap) throws Exception {
		try {
			log.info("===>准备调用发送给CRM的消息: " + inmap);
			String sCurTime = DateUtils.getCurDate(DateUtils.DATE_FORMAT_YYYYMMDDHHMISS);
			Map<String, Object> oprMap = new HashMap<String, Object>();
			oprMap.put("OP_CODE", "8285");
			oprMap.put("OP_TIME", sCurTime);
			oprMap.put("LOGIN_NO", "system");
			Map<String, Object> sendFee = new HashMap<String, Object>();
			sendFee.put("ELEC_ACCEPT", MapUtils.getString(inmap, "REQUEST_SN"));// 航信流水（C开头的那个）
			sendFee.put("INVC_CODE", MapUtils.getString(inmap, "INV_CODE"));
			sendFee.put("INVOICE_ID", MapUtils.getString(inmap, "INV_NO"));
			sendFee.put("INVC_TYPE", MapUtils.getString(inmap, "INV_TYPE"));// 开票类型
			sendFee.put("BILL_ID", MapUtils.getString(inmap, "PRINT_SN"));// 订单号
			sendFee.put("OP_DATE", sCurTime);
			Map<String, Object> routingMap = new HashMap<String, Object>();
			MapUtils.safeAddToMap(routingMap, "ROUTE_KEY", "10");
			MapUtils.safeAddToMap(routingMap, "ROUTE_VALUE", MapUtils.getString(inmap, "PHONE_NO"));

			MBean sendBusi = new MBean();
			sendBusi.setRoot("ROOT.HEADER.ROUTING", routingMap);
			sendBusi.addBody("OPR_INFO", oprMap);
			sendBusi.addBody("BUSI_INFO", sendFee);
			Map<String, Object> bbMap = new HashMap<String, Object>();
			bbMap.put("LOGIN_ACCEPT", MapUtils.getString(inmap, "PRINT_SN"));
			bbMap.put("CONTACT_ID", null);
			bbMap.put("BUSIID_NO", MapUtils.getString(inmap, "PHONE_NO"));
			bbMap.put("LOGIN_NO", "system");
			bbMap.put("OP_CODE", "8285");
			bbMap.put("OWNER_FLAG", "1");
			bbMap.put("ORDER_ID", "10014");// 与订单系统同步资源信息
			bbMap.put("ODR_CONT", sendBusi);
			busiMsgSnd.opPubOdrSndInter(bbMap);
		} catch (Exception e) {
			e.printStackTrace();
			throw e;
		}

		return;
	}

	@Override
	public Map<String, String> getEleInvoiceIssue(InvoiceInfo eleInvoice, InvoiceXhfInfo xhfInfo, String asynFlag) {

		// 组装报文
		MBean reqBean = null;
		String sEaiServe = "";
		if (asynFlag.equals("0")) { // 同步
			sEaiServe = "EAI_ElecInvoicePrint_SYN";
			reqBean = genReqInfo(eleInvoice, xhfInfo, "ECXML.FPKJ.BC.E_INV_SYN");
		} else { // 异步
			sEaiServe = "EAI_ElecInvoicePrint_ASYN";
			reqBean = genReqInfo(eleInvoice, xhfInfo, "ECXML.FPKJ.BC.E_INV_ASYN");
		}
		String requestSn = eleInvoice.getInvoiceHeader().getFpqqlsh();
		// 调用CRMPD接口
		long HXstart = ValueUtils.longValue(DateUtils.getCurDate("yyyyMMddHHmmssSSS"));
		log.debug("===> reQuestSn : {},调用开具请求报文:{} ", requestSn, reqBean);
		Map<String, String> EaiResult = CrossEntity.callService(sEaiServe, reqBean);
		log.debug("===> reQuestSn : {},调用开具响应结果:{} ", requestSn, EaiResult);
		long HXend = ValueUtils.longValue(DateUtils.getCurDate("yyyyMMddHHmmssSSS"));
		log.error("调用航信开始时间--" + HXstart + "--调用航信结束时间--" + HXend + "--调用航信总用时--" + (HXend - HXstart));
		EaiResult.put("TIME", (HXend - HXstart) + "");
		return EaiResult;
	}

	/**
	 * 生成发送报文
	 * 
	 * @param eleInvoice
	 * @param xhfInfo
	 * @param servName
	 * @return
	 */
	@SuppressWarnings("all")
	private MBean genReqInfo(InvoiceInfo eleInvoice, InvoiceXhfInfo xhfInfo, String servName) {

		// 获取数据交换流水号（唯一） requestCode+8位日期(YYYYMMDD)+9位序列号
		long changerSn = control.getSequence("SEQ_EINVOICE_SN");
		String dataExchangeId = "23" + DateUtils.getCurYm() + changerSn;

		MBean serviceMBean = new MBean();
		serviceMBean.setBody("terminalCode", "1"); // 终端类型标识代码 0:B/S请求来源 1:C/S请求来源
		serviceMBean.setBody("appId", "ZZS_PT_DZFP"); // 应用标识 默认为ZZS_PT_DZFP：增值税普通电子发票
		serviceMBean.setBody("version", "2.0"); // 接口版本 默认为2.0
		serviceMBean.setBody("interfaceCode", servName); // 接口编码
		serviceMBean.setBody("userName", CommonConst.USERNAME); // 平台编码
		serviceMBean.setBody("password", CommonConst.PASSWORD); // 密码
		serviceMBean.setBody("requestCode", "23"); // 各省区域编码 黑龙江23
		serviceMBean.setBody("requestTime", DateUtils.getCurDate("yyyy-MM-dd HH:mm:ss SSS")); // 数据交换请求发出时间
		serviceMBean.setBody("taxpayerId", eleInvoice.getInvoiceHeader().getXhfnsrsbh()); // 纳税人识别号
		serviceMBean.setBody("authorizationCode", xhfInfo.getSqm()); // 纳税人授权码
		serviceMBean.setBody("responseCode", ""); // 数据交换请求接受方代码,由平台提供，企业调用时为空
		serviceMBean.setBody("dataExchangeId", dataExchangeId); // 数据交换流水号（唯一） requestCode+8位日期(YYYYMMDD)+9位序列号
		serviceMBean.setBody("returnCode", "");
		serviceMBean.setBody("returnMessage", "");

		// 设置content
		String content = BeanToXmlUtils.trans(eleInvoice);
		content = content.replaceAll("<FPKJXX_XMXXS>", "<FPKJXX_XMXXS class=\"FPKJXX_XMXX;\" size=\"" + eleInvoice.getInvoiceDetail().size() + "\">");
		log.debug("报文内容：" + content);
		serviceMBean.setBody("content", content);

		return serviceMBean;
	}

	@Override
	public InvoiceHeaderInfo getEleInvHeader(InvoiceXhfInfo xhfInfo, String opCode, String custName, String phoneNo, String loginName,
			String loginAccept, long printFee) {
		// 电子发票的头信息
		InvoiceHeaderInfo headInfo = new InvoiceHeaderInfo();
		try {
			InstantiationUtils.reflect(headInfo);
		} catch (Exception e) {
			e.printStackTrace();
		}
		String requestSn = control.getRequestSn();
		// 发票头信息
		headInfo.setFpqqlsh(requestSn);
		headInfo.setPtbm(CommonConst.USERNAME);
		headInfo.setNsrsbh(xhfInfo.getXhfnsrsbh());
		headInfo.setNsrmc(xhfInfo.getXhfmc());
		headInfo.setDkbz("0");
		headInfo.setKpxm(opCode);
		headInfo.setXhfnsrsbh(xhfInfo.getXhfnsrsbh());
		headInfo.setXhfmc(xhfInfo.getXhfmc());
		headInfo.setXhfdz(xhfInfo.getXhfdz());
		headInfo.setXhfdh(xhfInfo.getXhfdh());
		headInfo.setXhfyhzh(xhfInfo.getXhfyhzh());
		headInfo.setGhfmc(custName);
		headInfo.setGhfsf("");
		headInfo.setGhfgddh(phoneNo);
		headInfo.setGhfsj(phoneNo);
		headInfo.setGhfqylx("03");
		headInfo.setKpy(loginName);
		headInfo.setSky(loginName);
		headInfo.setFhr(xhfInfo.getFhr());
		headInfo.setKplx("1");
		headInfo.setCzdm("10");
		headInfo.setKphjje(ValueUtils.transFenToYuan(printFee) + "");
		return headInfo;
	}

	@Override
	public InvoiceDetailInfo getInvoiceItem(long fee, String feeName, String TypeFPHXZ) {
		InvoiceDetailInfo invoiceItem = new InvoiceDetailInfo();
		try {
			invoiceItem = (InvoiceDetailInfo) InstantiationUtils.reflect(invoiceItem);
		} catch (Exception e) {
			e.printStackTrace();
		}

		invoiceItem.setXmmc(feeName);
		invoiceItem.setXmsl("1");
		invoiceItem.setFphxz(TypeFPHXZ);
		invoiceItem.setXmdj(ValueUtils.transFenToYuan(fee) + "");
		invoiceItem.setXmje(ValueUtils.transFenToYuan(fee) + "");
		invoiceItem.setSl("*");
		invoiceItem.setSe("*");
		invoiceItem.setXmdw("");
		return invoiceItem;
	}

	@Override
	public InvoiceDdInfo getOrderInfo(String orderId) {
		InvoiceDdInfo ddInfo = new InvoiceDdInfo();
		try {
			ddInfo = (InvoiceDdInfo) InstantiationUtils.reflect(ddInfo);
		} catch (Exception e) {
			e.printStackTrace();
		}
		ddInfo.setDdh(orderId);
		return ddInfo;
	}

	@Override
	public InvQryParam EInvcContentDeal(String content) {

		Object invQryParam = null;
		Document doc = null;

		// 解析contentXML报文，并保存在InvQryParam实体里
		try {
			doc = DocumentHelper.parseText(content);

			Element rootElt = doc.getRootElement();
			List<Element> listElement = rootElt.elements();
			Class[] cArg = new Class[1];
			cArg[0] = String.class;
			if (listElement != null && listElement.size() > 0) {

				Class clazz = Class.forName("com.sitech.acctmgr.atom.domains.InvQryParam");
				invQryParam = clazz.newInstance();
				for (Element node : listElement) {
					String methodName = "set" + node.getName().substring(0, 1) + node.getName().substring(1).toLowerCase();
					Method func = clazz.getDeclaredMethod(methodName, cArg);
					func.invoke(invQryParam, node.getTextTrim());
				}
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		return (InvQryParam) invQryParam;
	}

	public IControl getControl() {
		return control;
	}

	public void setControl(IControl control) {
		this.control = control;
	}

	public IShortMessage getShortMessage() {
		return shortMessage;
	}

	public void setShortMessage(IShortMessage shortMessage) {
		this.shortMessage = shortMessage;
	}

	public IBusiMsgSnd getBusiMsgSnd() {
		return busiMsgSnd;
	}

	public void setBusiMsgSnd(IBusiMsgSnd busiMsgSnd) {
		this.busiMsgSnd = busiMsgSnd;
	}

}
