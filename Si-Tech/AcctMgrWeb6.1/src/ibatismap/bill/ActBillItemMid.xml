<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="act_billitem_mid">

	<insert id="iActBillItemMid">
		INSERT INTO ACT_BILLITEM_MID
		(ID_NO, CONTRACT_NO, NATURAL_MONTH, BILL_CYCLE, CYCLE_TYPE, BILL_DAY,
		BILL_BEGIN, ITEM_ID, PRINT_FLAG, SHOULD_PAY, FAVOUR_FEE, PAYED_PREPAY,
		PAYED_LATER, TAX_RATE, VAT_EXCLUDED, TAX_FEE, BILL_END)
		SELECT A.ID_NO, A.CONTRACT_NO, DECODE (TO_NUMBER (SUBSTR (C.ACCT_ITEM_ATTR,
		2, 1)), 0, A.BILL_CYCLE, A.NATURAL_MONTH),
		A.BILL_CYCLE, A.CYCLE_TYPE, A.BILL_DAY, A.BILL_BEGIN, NVL (B.PARENT_ITEM_ID,
		'0000000007'),
		TO_NUMBER (SUBSTR (C.ACCT_ITEM_ATTR, 2, 1)) PRINT_FLAG, SUM (A.SHOULD_PAY), SUM
		(A.FAVOUR_FEE),
		SUM (A.PAYED_PREPAY), SUM (A.PAYED_LATER), A.TAX_RATE,
		SUM(VAT_EXCLUDED) VAT_EXCLUDED, SUM(TAX_FEE) TAX_FEE, A.BILL_END
		FROM ACT_BILL_MID A, ACT_BILLITEM_REL B, ACT_ITEM_CONF C
		WHERE A.ACCT_ITEM_CODE = B.ITEM_ID(+) AND A.ACCT_ITEM_CODE =
		C.ACCT_ITEM_CODE(+) AND B.PARENT_LEVEL = '0'
		GROUP BY A.ID_NO, A.CONTRACT_NO, A.NATURAL_MONTH, A.BILL_CYCLE,
		A.CYCLE_TYPE, A.BILL_DAY, A.BILL_BEGIN,
		B.PARENT_ITEM_ID, TO_NUMBER (SUBSTR (C.ACCT_ITEM_ATTR, 2, 1)), A.TAX_RATE, A.BILL_END
	</insert>

	<update id="uActBillItemMidSetIdNo">
		UPDATE ACT_BILLITEM_MID SET ID_NO = 0
	</update>

</sqlMap>
  