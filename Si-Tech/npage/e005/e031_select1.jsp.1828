<%
/********************
 version v2.0
开发商: si-tech
********************/
%>
<%@ page contentType= "text/html;charset=gb2312" %>
<%@ page import="com.sitech.boss.pub.config.*" %>
<%@ page import="com.sitech.boss.pub.util.*"%>
<%@ include file="../../page/common/pwd_comm.jsp" %>
<%@ page import="com.sitech.boss.s1310.viewBean.*" %>
<%@ page import="com.sitech.boss.amd.viewbean.*" %>
<%@ page import="java.io.*"%>
<%@ page import="java.util.*"%>
<%@ taglib uri="/WEB-INF/wtc.tld" prefix="wtc" %>
<%@ page import="com.sitech.boss.pub.CallRemoteResultValue" %>
<!--xl add-->
<%@ include file="/npage/include/public_title_name.jsp" %>
<%@ include file="/npage/common/popup_window.jsp" %>
<%/*
* name    :
* author  : changjiang@si-tech.com.cn
* created : 2003-11-01
* revised : 2003-12-31
*/%>
<%  	  
   
    ArrayList arr = (ArrayList)session.getAttribute("allArr");
    String[][] baseInfo = (String[][])arr.get(0);
    String workno = baseInfo[0][2];
    String workname = baseInfo[0][3];
	String belongName = baseInfo[0][16];	//orgcode

	String orgcode = "ap";
	String op_code = "e031";
	String opCode = "e031"  ;
	String opName = "宽带补收"  ;
	String contractno=request.getParameter("contractno");
	String phoneno=request.getParameter("phoneNo");
  	String dateStr=new java.text.SimpleDateFormat("yyyyMMdd").format(new java.util.Date());
	String sRegionCode = belongName.substring(0,2);

	System.out.println("aaaaaaabcdef"+sRegionCode);

ArrayList arlist = new ArrayList();

	try
	{	s1310Impl viewBean = new s1310Impl();//实例化viewBean
		arlist = viewBean.s2201Init(phoneno,contractno,workno,belongName,op_code);
	}
	catch(Exception e)
	{
		//System.out.println("调用EJB发生失败！");
	}

String [][] result = new String[][]{};
result = (String[][])arlist.get(0);
String return_code =result[0][0];
String return_message =result[0][1];
String error_msg = SystemUtils.ISOtoGB(ErrorMsg.getErrorMsg(return_code));
%>

<%
if (!return_code.equals("000000")) {
%><script language="JavaScript">
rdShowMessageDialog("查询错误！<br>错误代码：'<%=return_code%>'。<br>错误信息：'<%=return_message%>'。",0);
history.go(-1);
</script>
<%}
String run_name = result[0][2];
String cust_name =result[0][3];
String cust_info =result[0][4];
run_name=run_name.trim();
cust_info=cust_info.trim();
cust_name=cust_name.trim();
%>

<HTML><HEAD><TITLE>黑龙江BOSS-单个号码费用补收</TITLE>
<META content="text/html; charset=gb2312" http-equiv=Content-Type>
<META content=no-cache http-equiv=Pragma>
<META content=no-cache http-equiv=Cache-Control>
<script type="text/javascript" src="../../js/rpc/src/core_c.js"></script>
<script language="JavaScript">


onload=function()
{
}
core.loadUnit("debug");
core.loadUnit("rpccore"); 
onload=function()
{		
	core.rpc.onreceive = doProcess;	
}

function doProcess(packet)
{

<%System.out.println("#########################################");%>
	//使用RPC的时候,以下三个变量作为标准使用.
	error_code = packet.data.findValueByName("errorCode");
	error_msg =  packet.data.findValueByName("errorMsg");
	verifyType = packet.data.findValueByName("verifyType");
	backArrMsg = packet.data.findValueByName("backArrMsg");

	self.status="";
		
	var tmpObj="";
	var i=0;
	var j=0;
	var ret_code=0;
	var tmpstr="";
	
	ret_code =  parseInt(error_code);
	//alert("111111111111111111111111" +error_code ); 
	//alert("111111111111111111111111" +error_msg ); 
	//alert("111111111111111111111111----------"            +   verifyType ); 
	//alert("111111111111111111111111" +backArrMsg );
	
	if( ret_code == 0 ){
	  tmpObj = "balanceType" 
	  document.all(tmpObj).options.length=0;
	  document.all(tmpObj).options.length=backArrMsg.length;	
      // alert("2222222222222222222222222222222"+backArrMsg);
		

       for(i=0;i<backArrMsg.length;i++)
	    {
		// alert("3333333333333333333333333333333" +backArrMsg.length );


		    document.all(tmpObj).options[i].text=backArrMsg[i][1];
		    document.all(tmpObj).options[i].value=backArrMsg[i][0];
 	        document.all(tmpObj).options[i].nv1=backArrMsg[i][1];
	        document.all(tmpObj).options[i].nv2=backArrMsg[i][0];
	//	 alert("33333333333333333   " + document.all(tmpObj).options[i].nv1);
	//	 alert("33333333333333333   " + document.all(tmpObj).options[i].nv2);

		
		 }
		}else{
			rdShowMessageDialog("取信息错误:"+error_msg+"!");
			return false;			
		}
	//changew();
}
function change()
{
		
	var dealType="";
	var sqlBuf="";
	var myPacket = new RPCPacket("getBalanceType.jsp","正在获得送费明细信息，请稍候......");
	dealType = document.all.dealType[document.all.dealType.selectedIndex].value;
	
	sqlBuf="select balance_code,short_desc from  sBalanceType "+
			" where region_code = '" + "<%=sRegionCode%>" +"'" +
			" and deal_type = '"+ dealType +"'"+
			" and begin_time <= '"+"<%=dateStr%> "+"'"+
			" and end_time >= '"+"<%=dateStr%> "+"'" ;

	myPacket.data.add("verifyType","1");
	myPacket.data.add("sqlBuf",sqlBuf);
	myPacket.data.add("recv_number",2);
	core.rpc.sendPacket(myPacket);
	delete(myPacket);		
}
/*function changew(){
alert("aaa");
with(document.form){
	balanceType.text=balanceType.options[balanceType.selectedIndex].nv1;
	balanceType.value=balanceType.options[balanceType.selectedIndex].nv2;
	}
}
*/

function isKeyNumberdot(ifdot)
{
    var s_keycode=(navigator.appname=="Netscape")?event.which:event.keyCode;
	if(ifdot==0)
		if(s_keycode>=48 && s_keycode<=57)
			return true;
		else
			return false;
    else
    {
		if((s_keycode>=48 && s_keycode<=57) || s_keycode==46)
		{
		      return true;
		}
		else if(s_keycode==45)
		{
		    return true;
		}
		else
			  return false;
    }
}
function form_load()
{
dynAddRow();
}

function checkfee()
{
var total_fee=0;
var prtFlag=0;
 if ( form.lines.value=="0"){
        rdShowMessageDialog("请选择增加一行后再确认！");
      document.form.inp.focus();
	  return false;
  }
if (typeof(document.form.fee_detail.length)!="undefined"){
for (var i=0;i< document.form.fee_detail.length;i++) {
		for (var j=i+1;j< document.form.fee_detail.length;j++) {
		if (document.form.fee_name[i].value==document.form.fee_name[j].value)
		       {   rdShowMessageDialog("同一种费用名称只能选择一次！");
      			  document.form.fee_name[j].focus();
				  return false; }
		}
		}
for (var i=0;i< document.form.fee_detail.length;i++) {
  if (document.form.fee_name[i].value=="0"){
  		rdShowMessageDialog("请选择费用名称！");
		document.form.fee_name[i].focus();
		return false;
  		}
  if (document.form.fee_detail[i].value==""||parseFloat(document.form.fee_detail[i].value,10)==0){
  		rdShowMessageDialog("输入金额不能为空或0！");
		document.form.fee_detail[i].focus();
		return false;
  		}
  var v_fee=document.form.fee_detail[i].value;
  var pos=v_fee.indexOf(".");
     if(pos!=-1)
   {
		if(pos>10)
		{
			rdShowMessageDialog("输入金额小数点前不能大于10位！");
			document.form.fee_detail[i].focus();
			return false;
		}
		if(v_fee.length-pos>3)
		{
			rdShowMessageDialog("输入金额小数点后不能大于2位！");
			document.form.fee_detail[i].focus();
			return false;
		}
		if(v_fee<-3000)
    {
	      rdShowMessageDialog("单笔负补收金额不能超过3000元！");
	      document.form.fee_detail[i].focus();
	      return false;
    }
    if(v_fee>1000000)
    {
	      rdShowMessageDialog("单笔正补收金额不能超过1000000元！");
	      document.form.fee_detail[i].focus();
	      return false;
    }
   }
   else
   {
		if(v_fee.length>10)
		{
			rdShowMessageDialog("输入金额小数点前不能大于10位！");
			document.form.fee_detail[i].focus();
			return false;
		}
		if(v_fee<-3000)
    {
	      rdShowMessageDialog("单笔负补收金额不能超过3000元！");
	      document.form.fee_detail[i].focus();
	      return false;
    }
    if(v_fee>1000000)
    {
	      rdShowMessageDialog("单笔正补收金额不能超过1000000元！");
	      document.form.fee_detail[i].focus();
	      return false;
    }
   }
 	 }
for (var i=0;i< document.form.fee_detail.length;i++) {
  total_fee=parseFloat(total_fee,10)+parseFloat(form.fee_detail[i].value,10);
  }
  var tmp1=toString(total_fee*100+0.5);
		if (tmp1.indexOf(".")!=-1){
			var tmp2 = tmp1.substring(0,tmp1.indexOf("."));
			var tmp3 = parseFloat(tmp2);
			total_fee=toString(tmp3/100);
		}
  document.form.total_pay.value=total_fee;
for (var i=0;i< document.form.fee_detail.length;i++) {
  if (parseFloat(document.form.fee_detail[i].value,10)*parseFloat(total_fee,10) <= 0.0 ){
		rdShowMessageDialog("对不起，不能同时做正补收和负补收！");
		document.form.fee_detail[i].focus();
		return false;
  }
  }

} //end if
else {
   if (document.form.fee_name.value=="0"){
  		rdShowMessageDialog("请选择费用名称！");
		document.form.fee_name.focus();
		return false;
  		}
  if (document.form.fee_detail.value=="" ||parseFloat(document.form.fee_detail.value,10)==0){
  		rdShowMessageDialog("输入金额不能为空或0！");
		document.form.fee_detail.focus();
		return false;
  		}
  var v_fee=document.form.fee_detail.value;
  var pos=v_fee.indexOf(".");
     if(pos!=-1)
   {
		if(pos>10)
		{
			rdShowMessageDialog("输入金额小数点前不能大于10位！");
			document.form.fee_detail.select();
			return false;
		}
		if(v_fee.length-pos>3)
		{
			rdShowMessageDialog("输入金额小数点后不能大于2位！");
			document.form.fee_detail.select();
			return false;
		}
		if(v_fee<-3000)
    {
	      rdShowMessageDialog("单笔负补收金额不能超过3000元！");
	      document.form.fee_detail[i].focus();
	      return false;
    }
    if(v_fee>1000000)
    {
	      rdShowMessageDialog("单笔正补收金额不能超过1000000元！");
	      document.form.fee_detail[i].focus();
	      return false;
    }
   }
   else
   {
		if(v_fee.length>10)
		{
			rdShowMessageDialog("输入金额小数点前不能大于10位！");
			document.form.fee_detail.select();
			return false;
		}
		if(v_fee<-3000)
    {
	      rdShowMessageDialog("单笔负补收金额不能超过3000元！");
	      document.form.fee_detail[i].focus();
	      return false;
    }
    if(v_fee>1000000)
    {
	      rdShowMessageDialog("单笔正补收金额不能超过1000000元！");
	      document.form.fee_detail[i].focus();
	      return false;
    }
   }
    total_fee=parseFloat(total_fee,10)+parseFloat(form.fee_detail.value,10);
      document.form.total_pay.value=total_fee;
}

	if(document.form.dealType.value.length == 0)
	{	
		rdShowMessageDialog("必须选择送费类型!");
		document.form.dealType.focus();
		return false;
	}
	if(document.form.balanceType.value.length == 0)
	{	
		rdShowMessageDialog("必须选择送费明细!");
		document.form.balanceType.focus();
		return false;
	}
	prtFlag = rdShowConfirmDialog("本次补收金额为"+total_fee+"元，是否确认补收？");
     			if (prtFlag==1){
     			form.sure.disabled=true;
form.reset.disabled=true;
document.form.action="e031_2.jsp";
form.submit();
}
}

function isNumberString (InString,RefString)
{
if(InString.length==0) return (false);
for (Count=0; Count < InString.length; Count++)  {
	TempChar= InString.substring (Count, Count+1);
	if (RefString.indexOf (TempChar, 0)==-1)
	return (false);
}
return (true);
}

function dynAddRow(){
			form.lines.value=parseInt(form.lines.value)+1;
			var tr1=dyntb.insertRow();
	        tr1.id="tr";
	        tr1.insertCell().innerHTML = '<td><div align=center><select name=fee_name class=button><option class=button value=0 selected></option><% 	try
 	{
      		ArrayList retArray = new ArrayList();
      		String [][] result_dyn = new String[][]{};
      		 CallRemoteResultValue value = null; 
	       ScallSvrViewBean viewBean1 = new ScallSvrViewBean();
        
      		/*String sqlStr ="select trim(fee_code)||'|'||trim(detail_code),trim(fee_code)||'-'||trim(detail_code)||'--'||trim(detail_name) from sFeeCodeDetail where fee_code !='*' and rownum<700 order by fee_code,detail_code";*/
			String sqlStr ="select trim(fee_code)||'|'||trim(detail_code),trim(fee_code)||'-'||trim(detail_code)||'--'||trim(detail_name) from sFeeCodeDetail where fee_code !='*' and   fee_code='0Y' order by fee_code,detail_code";
      	  String inParas[] = {sqlStr};
      	  value=viewBean1.callService("0", null, "TlsPubSelBoss","2",inParas); 
      	//callRemoteResultValue = viewBean.callService("0", null, "TlsPubSelBoss", "13", inParas);
      		//System.out.println(sqlStr);
      		//retArray = callView.s1330Query("2",sqlStr);
      		result_dyn = value.getData();
      		int recordNum = result_dyn.length;
      		//result_dyn = (String[][])retArray.get(1);
      		for(int i=0;i<recordNum;i++){
        		out.print("<option class=button value=" + result_dyn[i][0] + ">" + result_dyn[i][1] + "</option>");
      		}
     	}catch(Exception e){
       		//System.out.println("Call queryView Failed!");
     	}
%></select></div></td>';
            tr1.insertCell().innerHTML = '<td> <div align=center><input type=text name=fee_detail value="0.00" class=button  onKeyPress="return isKeyNumberdot(1)"></div></td>';
}

//-->
</script>
 
</HEAD>
<BODY   leftmargin="0" topmargin="0" onLoad="form_load();">
<FORM action="" method=post name=form>
<%@ include file="/npage/include/header.jsp" %>
<input type="hidden" name="lines" value="0">
<input type=hidden name=optype value="<%=request.getParameter("optype")%>">
  <table width="767" border="0" cellspacing="0" cellpadding="0" align="center">
    <tr>
          
          
        <table width="98%" border="0" cellspacing="0" cellpadding="0" align="center"  >
          <tr id="footer">
            <td width="45%"> <br>
              <table width=100% height=25 border=0 align="center" cellspacing=2 cellpadding="4">
                <tbody>
                <tr  >
                  <td width="13%">操作类型：</td>
                  <td width="35%">
              <%
              String i1="无主追加";
              String i2="单个号码费用补收";
              String op1=request.getParameter("optype");
              if (op1.equals("0") ) {
              %>
              <%=i1%>
              <%}else if (op1.equals("1") ) {
              %>
              <%=i2%>
              <%
              }%>
                  </td>
                  <td width="13%">部门：</td>
                  <td width="39%"><%=belongName%></td>
                </tr>
                </tbody>
              </table>
              <table width=100% height=25 border=0 align="center" cellspacing=2>
                <tr  >
                  <td width="13%">宽带号码：</td>
                  <td width="35%">
                    <%=request.getParameter("phoneno")%><!--phoneno是KDZ;phoneNo是209 -->
                  </td>
                  <td width="13%" align="left">归属年月：</td>
                  <td width="39%">
                   <%=request.getParameter("billmonth")%>
				   <input type="hidden" name="billmonth" value="<%=request.getParameter("billmonth")%>">
                  </td>
                </tr>
                <tr  >
                  <td width="13%">帐户号码：</td>
                  <td width="35%">
                 <%=request.getParameter("contractno")%> 
				 <input type="hidden" name="contractno" value="<%=contractno%>">
                  </td>
                  <td width="13%">客户名称：</td>
                  <td width="39%">
                    <%=cust_name%> 
                  </td>
                </tr>
                <tr  >
                  <td width="13%">运行状态： </td>
                  <td width="35%">
                <%=run_name%> 
                  </td>
                  <td width="13%">客户信息：</td>
                  <td width="39%">
                  <%=cust_info%> 
                  </td>
                </tr>
				<tr  >
                  <td width="13%"   >铁通号码 </td>
                  <td width="35%" colspan = 3>
                   <%=phoneno%>
                  </td>
                 <input type = "hidden" name = "phone_kd" value="<%=phoneno%>" >
                </tr>
              </table>
              <table width=100% height=25 border=0 align="center" cellspacing=2>
                <tr  >
                  <td colspan="4">以下为可调整的费用信息：</td>
                </tr>
              </table>

			<table width=100% height=25 border=0 align="center" cellspacing=2>
				<tr id="DealType"  > 
					<td width="13%" >
						<div align="left" >送费类型</div></td>
					<td width="35%">
                  <select name="dealType" onChange="change()">
                  <option value="" selected></option>
                    <% 	try
		   {
		  		ArrayList retArray = new ArrayList();
      			String [][] result1 = new String[][]{};
      			s1310Impl callView = new s1310Impl();
      			String sqlStr ="select  deal_name,to_char(deal_type) from sDealType ";
	      		//System.out.println(sqlStr);      		
		  	//	retArray = callView.s1330Query("2",sqlStr);
      			%>
<wtc:pubselect name="TlsPubSelBoss"   outnum="2">
	  	<wtc:sql><%=sqlStr%>
</wtc:sql>

</wtc:pubselect >
<wtc:array id="retList"   scope="end" />
           <%
      		//	int recordNum = Integer.parseInt((String)retArray.get(0));
      			  int recordNum =retList.length;
      			//result1 = (String[][])retArray.get(1);
      			result1 =retList;
      			for(int i=0;i<recordNum;i++){
        		out.print("<option class=button value= "+result1[i][1]+">"+result1[i][0] + "</option>");
      			}
	     	}catch(Exception e){
       		//System.out.println("Call queryView Failed!");
     		}          
		%>
						</select>
					</td>
				<td width="13%" >
					<div align="left"  >送费明细</div>
				</td>
                <td width="39%">
					<select name="balanceType" id="balanceType"  >
		            <option value="" selected></option>
					</select> 
				</td>			
			</tr>
			</table>
              <TABLE id=dyntb width=100%   height=23 border=0 align="center" cellpadding="2" cellSpacing=1>
          <TBODY>
		  
			
          <tr  >
            <td width="40%" >
              <div align="center">费用名称</div>
            </td>
            <td>
              <div align="center">金额</div>
            </td>
            <input type="button" name="inp" class="b_foot"   id="inp" value="添加" onClick="dynAddRow()">
          </tr>
		  </TBODY>
          </TABLE>
              <table width=100% height=25 border=0 align="center" cellspacing=1 cellpadding="4">
                <tbody>
                <tr >
                  <td width=13%>金额总计：</td>
                  <td width="87%">
                     <input type="text"  class="button" name="total_pay" readonly value="">
                  </td>
                </tr>
                <tr  >
                  <td width="13%">备注信息：</td>
                  <td width="87%">
                    <input type="text"  class="button" name="remark" maxlength="60" size="80">
                  </td>
                </tr>
                </tbody>
              </table>
              <table width="100%" border=0 align=center cellpadding="4" cellspacing=1>
                <tbody>
                <tr id="footer" >
                  <td align=center   width="100%">
                    <input class="b_foot" name=sure type=button value=确认 onclick="checkfee()">
                    <input class="b_foot" name=reset type=reset value=返回 onClick="window.history.go(-1)">
                    &nbsp; </td>
                </tr>
                </tbody>
              </table>
              
            </td>
          </tr>
        </table>
        <br>
      </td>
    </tr>
  </table>
 </FORM>
</BODY></HTML>
